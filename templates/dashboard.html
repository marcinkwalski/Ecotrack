{% extends "base.html" %}
{% block content %}

<div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
    <div>
        <h1 class="mb-1">Panel użytkownika</h1>
        <p class="text-secondary mb-0">Kontroluj emisje, analizuj trendy i wykonuj symulacje.</p>
    </div>
    <div class="d-flex gap-2">
        <button onclick="window.location.href='{{ url_for('export_csv') }}'" class="btn btn-outline-success">Eksport CSV</button>
        <button onclick="window.location.href='{{ url_for('export_pdf') }}'" class="btn btn-success">Eksport PDF</button>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-12 col-sm-6 col-lg-4">
        <div class="card h-100 shadow-sm metric-card">
            <div class="card-body">
                <div class="metric-label">Łączna emisja</div>
                <div class="metric-value">{{ total_sum|round(2) }} kg CO₂</div>
                <div class="text-secondary small">Prognoza roczna: {{ predicted_annual|round(1) }} kg</div>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-lg-4">
        <div class="card h-100 shadow-sm metric-card">
            <div class="card-body">
                <div class="metric-label">7 dni</div>
                <div class="metric-value">{{ last_7|round(2) }} kg</div>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-lg-4">
        <div class="card h-100 shadow-sm metric-card">
            <div class="card-body">
                <div class="metric-label">30 dni</div>
                <div class="metric-value">{{ last_30|round(2) }} kg</div>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-lg-4">
        <div class="card h-100 shadow-sm metric-card">
            <div class="card-body">
                <div class="metric-label">365 dni</div>
                <div class="metric-value">{{ last_365|round(2) }} kg</div>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-lg-4">
        <div class="card h-100 shadow-sm metric-card">
            <div class="card-body">
                <div class="metric-label">Porównanie z PL</div>
                <div class="metric-value">{{ compare_percent|round(1) }}%</div>
                <div class="text-secondary small">Średnia PL: {{ poland_avg }} kg/rok</div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card shadow-sm mb-4">
            <div class="card-header">Dodaj emisję</div>
            <div class="card-body">
                <form method="post" action="{{ url_for('add_emission') }}" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Kategoria</label>
                        <select id="category" name="category" class="form-select" required>
                            <option value="transport">Transport</option>
                            <option value="food">Jedzenie</option>
                            <option value="energy">Energia</option>
                            <option value="other">Inne</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Podkategoria</label>
                        <select id="subcategory" name="subcategory" class="form-select" required></select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Ilość</label>
                        <input name="amount" type="number" step="0.01" class="form-control" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Jednostka</label>
                        <input id="unit" name="unit" type="text" class="form-control" readonly>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Notatka</label>
                        <input name="note" type="text" class="form-control">
                    </div>

                    <div class="col-12">
                        <button class="btn btn-success w-100" type="submit">Dodaj emisję</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-3">
                <span>Wykres emisji (historyczny)</span>
                <div class="d-flex flex-wrap align-items-center gap-2">
                    <label for="rangeSelect" class="form-label mb-0 text-secondary">Zakres</label>
                    <select id="rangeSelect" class="form-select form-select-sm w-auto">
                        <option value="7">7 dni</option>
                        <option value="30">30 dni</option>
                        <option value="90">90 dni</option>
                        <option value="365">Rok</option>
                        <option value="all" selected>Całość</option>
                    </select>
                    <div class="btn-group btn-group-sm" role="group" aria-label="Typ wykresu">
                        <button type="button" class="btn btn-outline-success chart-type-btn active" data-chart-type="line">Line</button>
                        <button type="button" class="btn btn-outline-success chart-type-btn" data-chart-type="bar">Bar</button>
                        <button type="button" class="btn btn-outline-success chart-type-btn" data-chart-type="area">Area</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="line-empty" class="chart-empty d-none">Brak danych do wyświetlenia wykresu.</div>
                <canvas id="emissionChart" class="chart-canvas"></canvas>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header">Udział kategorii emisji</div>
            <div class="card-body position-relative">
                <div id="pie-empty" class="chart-empty d-none">Brak danych do podziału kategorii.</div>
                <canvas id="pieChart" class="chart-canvas"></canvas>
                <div id="pie-tooltip" class="chart-tooltip"></div>
                <div id="pie-legend" class="chart-legend mt-3"></div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header">Symulacja „Co jeśli?”</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Kategoria</label>
                        <select id="sim-category" class="form-select">
                            <option value="">-- wybierz --</option>
                            <option value="transport">Transport</option>
                            <option value="food">Żywność</option>
                            <option value="energy">Energia</option>
                            <option value="other">Inne</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Podkategoria</label>
                        <select id="sim-subcategory" class="form-select">
                            <option value="">-- wybierz kategorię --</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Zmiana ilości</label>
                        <input id="sim-amount" type="number" class="form-control" placeholder="np. 50">
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button id="sim-run" class="btn btn-success w-100">Przelicz</button>
                    </div>
                </div>
                <div id="sim-result" class="mt-3 d-none"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header">Historia emisji</div>
            <div class="card-body">
                <div class="history-list">
                    {% for r in records %}
                    <div class="history-row">
                        <div class="history-category">
                            <span class="history-category-chip" aria-label="{{ r.category }}">
                                {% if r.category == "transport" or r.category == "Transport" %}
                                <i class="bi bi-car-front"></i>
                                {% elif r.category == "food" or r.category == "jedzenie" or r.category == "Jedzenie" %}
                                <i class="bi bi-basket2"></i>
                                {% elif r.category == "energy" or r.category == "energia" or r.category == "Energia" %}
                                <i class="bi bi-lightning-charge"></i>
                                {% else %}
                                <i class="bi bi-three-dots"></i>
                                {% endif %}
                            </span>
                        </div>
                        <div class="history-desc">
                            <div class="history-title" title="{{ SUBCATEGORY_LABELS.get(r.subcategory, r.subcategory) }}">{{ SUBCATEGORY_LABELS.get(r.subcategory, r.subcategory) }}</div>
                            <div class="history-meta text-secondary">
                                {{ r.created_at.strftime("%Y-%m-%d %H:%M") }}
                            </div>
                        </div>
                        <div class="history-metrics">
                            <div class="history-amount"><span class="amount">{{ r.raw_amount }}</span> {{ r.amount_unit }}</div>
                            <div class="history-co2 text-secondary">{{ "%.3f"|format(r.value) }} kg CO₂</div>
                        </div>
                        <div class="history-actions">
                            <a href="{{ url_for('edit_emission', id=r.id) }}" class="btn btn-outline-success btn-sm" aria-label="Edytuj">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <form action="{{ url_for('delete_emission', id=r.id) }}" method="post" class="d-inline">
                                <button class="btn btn-outline-success btn-sm" type="submit" aria-label="Usuń">
                                    <i class="bi bi-trash3"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script id="records-data" type="application/json">{{ records_json | tojson }}</script>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
